<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.7, user-scalable=no">
    <title>Explore Courses - Course World Web</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-i18n@9/dist/vue-i18n.global.js"></script>
    <link rel="stylesheet" href="/background.css">
    <link rel="stylesheet" href="/fonts.css">
    <link rel="stylesheet" href="/stages/detailed_search/font.css">
    <link rel="stylesheet" href="/stages/detailed_search/index.css">
    <link rel="stylesheet" href="/rotating.css">
</head>

<body>
<div id="app">
    <div class="nm-detailed-search-root">
        <div class="nm-detailed-search-head">
            <div class="nm-detailed-search-head-item nm-detailed-search-head-item-left">
                <img draggable="false" src="/assets/images/spr_nm_castle.png" alt="castle">
                <div class="font-detailed-search nm-detailed-search-head-title">
                    {{ $t('title.title') }}
                </div>
            </div>
            <div class="nm-detailed-search-head-item nm-detailed-search-head-item-right">
                <div class="nm-pager" id="pager-left">
                    <img draggable="false" src="/assets/images/spr_nm_pages_left.png" alt="pager-left">
                </div>
                <div class="nm-pager" id="pager-text">
                    <img draggable="false" src="/assets/images/spr_nm_pages_mask.png" alt="pager-text">
                    <div class="font-detailed-search">{{pageNum}}</div>
                </div>
                <div class="nm-pager" id="pager-right">
                    <img draggable="false" src="/assets/images/spr_nm_pages_right.png" alt="pager-right">
                </div>
                <div class="nm-menu-principal">
                    <img draggable="false" src="/assets/images/spr_menu.png" alt="menu-principal">
                </div>
            </div>
        </div>
        <div class="nm-detailed-search-robot">
            <img draggable="false" src="/assets/images/spr_engine_bot.png" alt="robot" class="rotating-slow">
        </div>
        <div class="planet-3">
            <img draggable="false" src="/assets/images/spr_nm_planet_3.png" alt="planet-3">
        </div>

        <div class="nm-detailed-search-tabs">
            <div class="nm-tab" :class="{ 'nm-tab-selected' : selectedTab === 1}" @click="switchTab(1)">
                <img draggable="false" src="/assets/images/spr_nm_tabs.png" alt="tab-featured">
                <span>{{ $t('title.featured')}}</span>
            </div>
            <div class="nm-tab" :class="{ 'nm-tab-selected' : selectedTab === 2}" @click="switchTab(2)">
                <img draggable="false" src="/assets/images/spr_nm_tabs.png" alt="tab-popular">
                <span>{{ $t('title.popular')}}</span>
            </div>
            <div class="nm-tab" :class="{ 'nm-tab-selected' : selectedTab === 3}" @click="switchTab(3)">
                <img draggable="false" src="/assets/images/spr_nm_tabs.png" alt="tab-latest">
                <span>{{ $t('title.latest')}}</span>
            </div>
            <div class="nm-tab" :class="{ 'nm-tab-selected' : selectedTab === 4}" @click="switchTab(4)">
                <img draggable="false" src="/assets/images/spr_nm_tabs.png" alt="tab-search">
                <span>{{ $t('title.search')}}</span>
            </div>
            <div class="nm-tab-clears" :class="{ 'nm-tab-clears-selected' : selectedTab === 5}" @click="switchTab(5)">
                <img draggable="false" class="nm-tab-clears-img" src="/assets/images/spr_nm_tabs_small.png"
                     alt="tab-clears">
                <img draggable="false" class="nm-tab-clears-ministar" src="/assets/images/spr_nm_ministar.png"
                     alt="tab-clears-ministar">
            </div>
        </div>


        <div class="nm-bg-grid-root">
            <div class="nm-bg-grid"></div>
        </div>
        <div class="nm-detailed-search-shadow">
            <img draggable="false" src="/assets/images/spr_nm_shadow.png" alt="shadow">
        </div>

        <div class="nm-detailed-search-rows">
            <div v-for="course in courseList" class="nm-detailed-search-row">
                <div class="nm-row-singleline">
                    <div class="nm-row-gamestyle" :style="getGameStyleCSS(course.apariencia)"></div>
                    <div class="nm-row-name">{{course.name}}</div>
                </div>
                <div>
                    <div class="nm-row-environment" :style="getEnvironmentCSS(course.apariencia, course.entorno)"></div>
                </div>
                <div class="nm-row-line nm-row-line1">
                    <img :src="`/assets/images/nm_icons/like${course.user_data.liked===0 ? 'd' : 's'}.png`" alt="like">
                    <div>{{course.likes}}</div>
                    <div class="gap"></div>
                    <img :src="`/assets/images/nm_icons/dislike${course.user_data.liked===1 ? 'd' : 's'}.png`" alt="like">
                    <div>{{course.dislikes}}</div>
                </div>
                <div class="nm-row-line nm-row-line2">
                    <img :src="`/assets/images/nm_icons/tag.png`" alt="like">
                    <div>{{course.etiquetas}}</div>
                </div>
                <div class="nm-row-maker">{{course.author}}</div>
            </div>
        </div>
    </div>
</div>

<script>
    const {createApp} = Vue;
    const {createI18n} = VueI18n;
    const urlParams = new URLSearchParams(window.location.search);

    const messages = {
        en_US: {
            page: {
                title: 'Explore Courses - Course World Web'
            },
            title: {
                title: 'Explore Courses',
                featured: 'Featured',
                popular: 'Popular',
                latest: 'Latest',
                search: 'Search',
            },
            message: {
                connection_failed: 'Connection failed',
            }
        },
        es_ES: {
            page: {
                title: 'Explorar Niveles - Niveles Mundiales Web'
            },
            title: {
                title: 'Explorar Niveles',
                featured: 'Prometedores',
                popular: 'Populares',
                latest: 'Novedades',
                search: 'Busqueda',
            },
            message: {
                connection_failed: 'Conexión fallida',
            }
        },
        zh_CN: {
            page: {
                title: '浏览关卡 - 全球关卡网页版'
            },
            title: {
                title: '浏览关卡',
                featured: '精选',
                popular: '热门',
                latest: '最新',
                search: '搜索',
            },
            message: {
                connection_failed: '连接失败',
            }
        }
    }

    const vm = createApp({
        data() {
            return {
                pageNum: 1,
                selectedTab: 3,
                token: '',
                authCode: '',
                gameStyleMap: {
                    0: 'smb', 1: 'smb3', 2: 'smw', 3: 'nsmbu'
                },
                environmentMap: {
                    0: 'ground',
                    1: 'underground',
                    2: 'castle',
                    3: 'underwater',
                    4: 'ghost',
                    5: 'airship',
                    6: 'forest',
                    7: 'sky',
                    8: 'desert',
                    9: 'snow',
                    10: 'fall',
                    11: 'beach',
                    12: 'mountain',
                    13: 'volcano'
                },
                courseList: {}
            }
        },
        created() {
            document.title = this.$t('page.title');
        },
        mounted() {
            const vm = this;
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/servers.json', true);
            xhr.send(null);
            xhr.onreadystatechange = () => {
                if (xhr.readyState === 4) {
                    if (xhr.status !== 200) {
                        alert(vm.$t('message.connection_failed'));
                    } else {
                        const servers = JSON.parse(xhr.responseText).servers;
                        const selectedServerId = urlParams.get('server');
                        if (selectedServerId === null) {
                            vm.server = servers[0];
                        } else {
                            vm.server = (() => {
                                for (const server of servers) {
                                    if (server.id === selectedServerId) {
                                        return server;
                                    }
                                }
                            })();
                        }
                        vm.token = vm.server.is_enginetribe ? vm.server.tokens[vm.$i18n.locale] : vm.server.token;
                        if (document.cookie.indexOf(`${vm.server.id}_auth_code=`) === -1) {
                            window.location.href = '/user/login/';
                        }
                        vm.authCode = document.cookie.split(`${vm.server.id}_auth_code`)[1].split(';')[0];
                        vm.imId = document.cookie.split(`${vm.server.id}_im_id`)[1].split(';')[0];
                        vm.loadCourseList();
                    }
                }
            }
        },
        methods: {
            switchTab(tab) {
                this.selectedTab = tab;
            },
            getGameStyleCSS(gamestyle) {
                if (this.gameStyleMap.hasOwnProperty(gamestyle)) {
                    return `background: url("/assets/images/gamestyles/${this.gameStyleMap[gamestyle]}.png"); background-size: 100% 100%;`
                } else {
                    return `background: url("/assets/images/gamestyles/unknown.png"); background-size: 100% 100%;`
                }
            },
            getEnvironmentCSS(gamestyle, environment) {
                if (this.gameStyleMap.hasOwnProperty(gamestyle)) {
                    if (this.environmentMap.hasOwnProperty(environment)) {
                        return `background: url("/assets/images/environments/${this.gameStyleMap[gamestyle]}/${this.environmentMap[environment]}.png"); background-size: 100% 100%;`
                    } else {
                        return `background: url("/assets/images/environments/unknown.png"); background-size: 100% 100%;`
                    }
                } else {
                    return `background: url("/assets/images/environments/unknown.png"); background-size: 100% 100%;`
                }
            },
            loadCourseList() {
                const vm = this;
                const xhr = new XMLHttpRequest();
                xhr.open('POST', vm.server.host + '/stages/detailed_search', true);
                xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                xhr.setRequestHeader('User-Agent', 'GameMaker HTTP')
                xhr.send(
                    'auth_code=' + vm.authCode +
                    '&discord_id=' + vm.imId +
                    '&token=' + vm.token
                );
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        if (xhr.status !== 200) {
                            alert(vm.$t('message.connection_failed') + '\n' + xhr.status);
                        } else {
                            const response = JSON.parse(xhr.responseText);
                            if (response.hasOwnProperty('error_type')) {
                                alert(response.error_type + ' - ' + response.message);
                            } else {
                                vm.courseList = response.result;
                            }
                        }
                    }
                }

            }
        }
    });

    const i18n = createI18n({
        locale: navigator.language.replace('-', '_'),
        fallbackLocale: ['en_US', 'es_ES', 'zh_CN'],
        messages
    });
    vm.use(i18n).mount('#app');
</script>
</body>